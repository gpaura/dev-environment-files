# ~/.tmux.conf - Final Configuration for Finance/Dev Workflow with Shared Session Support

# ============================================================================
# GENERAL SETTINGS
# ============================================================================

unbind C-b
set-option -g prefix C-a
bind-key C-a send-prefix

set -g mouse on
set -g base-index 1
setw -g pane-base-index 1
set -g renumber-windows on
set -g history-limit 50000
setw -g monitor-activity on
set -g visual-activity on
set -s escape-time 10
set -g repeat-time 300

set -g default-terminal "screen-256color"
set -ga terminal-overrides ",*256col*:Tc"
set -g set-clipboard on
set -g focus-events on

# ============================================================================
# KEY BINDINGS
# ============================================================================

bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

bind r source-file ~/.tmux.conf \; display-message "tmux.conf reloaded!"

# ============================================================================
# VIM-TMUX-NAVIGATOR INTEGRATION
# ============================================================================

is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"

unbind C-h
unbind C-j
unbind C-k
unbind C-l

bind-key 'C-h' if-shell "$is_vim" 'send-keys C-h' 'select-pane -L'
bind-key 'C-j' if-shell "$is_vim" 'send-keys C-j' 'select-pane -D'
bind-key 'C-k' if-shell "$is_vim" 'send-keys C-k' 'select-pane -U'
bind-key 'C-l' if-shell "$is_vim" 'send-keys C-l' 'select-pane -R'

bind-key -T copy-mode-vi 'C-h' select-pane -L
bind-key -T copy-mode-vi 'C-j' select-pane -D
bind-key -T copy-mode-vi 'C-k' select-pane -U
bind-key -T copy-mode-vi 'C-l' select-pane -R

bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind -n M-Left select-pane -L
bind -n M-Right select-pane -R
bind -n M-Up select-pane -U
bind -n M-Down select-pane -D

# Enhanced window switching (your existing + more)
bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

# Quick window navigation
bind -n C-M-h previous-window
bind -n C-M-l next-window

# ============================================================================
# COPY MODE (VI-STYLE)
# ============================================================================

setw -g mode-keys vi

unbind -T copy-mode-vi v
unbind -T copy-mode-vi y
unbind -T copy-mode-vi r

bind-key -T copy-mode-vi 'v' send-keys -X begin-selection
bind-key -T copy-mode-vi 'y' send-keys -X copy-pipe-and-cancel "pbcopy"
bind-key -T copy-mode-vi 'r' send-keys -X rectangle-toggle

bind [ copy-mode
bind ] paste-buffer

# ============================================================================
# ENHANCED STATUS BAR WITH GREEN THEME + SHARED SESSION INFO
# ============================================================================

# Status bar refresh every second for live clock
set -g status-interval 1

# Status bar positioning
set-option -g status-position bottom

# Status bar colors
set -g status-bg colour235
set -g status-fg colour255

# Left status - Enhanced with window count and session info
set -g status-left-length 40
set -g status-left '#[fg=colour46,bold]󰣇 #S #[fg=colour226]| #[fg=colour46]#{session_windows}w #[fg=colour226]| '

# Right status - Show current window info (keeping your preference for no time)
set -g status-right-length 40
set -g status-right '#[fg=colour226]#{window_index}:#{window_name} '

# Window status format (keeping your original)
setw -g window-status-format ' #I:#W '
setw -g window-status-current-format '#[fg=colour235,bg=colour46,bold] #I:#W '

# Window status separator
setw -g window-status-separator ''

# Activity and bell colors (GREEN theme)
setw -g window-status-activity-style fg=colour46,bg=colour235,bold
setw -g window-status-bell-style fg=colour235,bg=colour46,bold

# Message and command line colors (GREEN theme)
set -g message-style bg=colour46,fg=colour235,bold
set -g message-command-style bg=colour235,fg=colour46,bold

# Copy mode colors (GREEN theme)
setw -g mode-style bg=colour46,fg=colour235,bold

# ============================================================================
# ENHANCED PANE SEPARATORS WITH STRONG VISUAL SEPARATION
# ============================================================================

# Modern tmux border options for better visibility
set -g pane-border-lines double              # Double-line borders for prominence
set -g pane-border-indicators colour         # Arrow indicators on active pane
set -g pane-border-status off                # Keep off as you prefer

# Enhanced border colors (your green theme)
set -g pane-border-style fg=colour238,bold
set -g pane-active-border-style fg=colour46,bold

# Additional visual enhancements
set -g display-panes-time 2000               # Show pane numbers longer
set -g display-panes-colour colour46         # Green for inactive panes
set -g display-panes-active-colour colour226 # Yellow for active pane

# Quick pane identification (Ctrl+a + q shows pane numbers prominently)
bind-key q display-panes -d 2000

# Enhanced pane highlighting (improved your existing 'm' binding)
bind-key m select-pane -P 'fg=black,bg=colour46' \; run-shell 'sleep 0.8' \; select-pane -P 'default'

# ============================================================================
# LAYOUT AND RESIZE
# ============================================================================

bind M-1 select-layout even-horizontal
bind M-2 select-layout even-vertical
bind M-3 select-layout main-horizontal
bind M-4 select-layout main-vertical
bind M-5 select-layout tiled

bind -r H resize-pane -L 5
bind -r J resize-pane -D 5
bind -r K resize-pane -U 5
bind -r L resize-pane -R 5

bind -r Left resize-pane -L 5
bind -r Down resize-pane -D 5
bind -r Up resize-pane -U 5
bind -r Right resize-pane -R 5

# ============================================================================
# ENHANCED SESSION MANAGEMENT + SHARED SESSION WORKFLOW
# ============================================================================

# Your existing session management (keep these)
bind X confirm-before -p "Kill session #S? (y/n)" kill-session
bind C-t new-session -d -s "trading" \; switch-client -t "trading"
bind C-d new-session -d -s "development" \; switch-client -t "development"
bind C-m new-session -d -s "monitoring" \; switch-client -t "monitoring"

# NEW: Enhanced window management for shared session workflow
bind N command-prompt -p "Window name:" "new-window -n '%%'"
bind R command-prompt -p "Rename window:" "rename-window '%%'"

# Quick workspace window creators
bind C-w new-window -n "workspace" -c "~"
bind C-f new-window -n "finance" -c "~/finance"
bind C-n new-window -n "notes" -c "~/notes"
bind C-s new-window -n "server" -c "~"

# Move windows left/right
bind -n C-S-Left swap-window -t -1\; select-window -t -1
bind -n C-S-Right swap-window -t +1\; select-window -t +1

# Session info and window management
bind I display-message -p "Session: #{session_name} | Windows: #{session_windows} | Clients: #{session_many_attached}"
bind W list-windows -F "#{window_index}: #{window_name} (#{pane_current_path})"

# Quick project creator
bind P command-prompt -p "Project name:" "new-window -n '%%' -c '~/dev/%%'"

# ============================================================================
# WINDOW TITLES AND AUTOMATION
# ============================================================================

# Enhanced window titles for better identification
set -g set-titles on
set -g set-titles-string "tmux:#{session_name}:#{window_name}"

# Auto-rename windows based on current command/path
setw -g automatic-rename on
setw -g automatic-rename-format '#{b:pane_current_path}'

# Rename window hooks for better defaults
set-hook -g after-new-window 'if -F "#{==:#{window_name},bash}" "rename-window \"#{b:pane_current_path}\""'
set-hook -g after-new-window 'if -F "#{==:#{window_name},zsh}" "rename-window \"#{b:pane_current_path}\""'

# ============================================================================
# VISUAL ENHANCEMENTS
# ============================================================================

# Optional: Uncomment for different background colors on active/inactive panes
# set -g window-style 'fg=colour247,bg=colour236'         # Inactive panes darker
# set -g window-active-style 'fg=colour255,bg=colour235'  # Active pane lighter

# Bell and activity settings
set -g bell-action any
set -g visual-bell off
set -g activity-action other

# ============================================================================
# SHARED SESSION UTILITIES
# ============================================================================

# Create layouts directory
run-shell 'mkdir -p ~/.tmux-layouts'

# Save/restore layouts
bind S command-prompt -p "Save layout as:" "run-shell 'tmux list-windows -F \"#{window_index}:#{window_name}:#{window_layout}\" > ~/.tmux-layouts/%%'"
bind L command-prompt -p "Load layout:" "source-file ~/.tmux-layouts/%%"

# Quick kill window with confirmation
bind K confirm-before -p "Kill [Window] #W? (y/n)" kill-window

# Kill window by number with prompt
bind k command-prompt -p "Kill [Window] number:" "kill-window -t %%"

# ============================================================================
# STARTUP HOOKS AND MESSAGES
# ============================================================================

# Show helpful info when tmux starts
set-hook -g session-created 'display-message -d 3000 "Session ready! C-a+I=info | C-a+W=windows | C-a+N=new window"'

# Send window change notifications for WezTerm integration
# set-hook -g after-select-window 'display-message -d 1000 "Window: #{window_name}"'
set-hook -g after-select-window 'if -F "#{!=:#{window_name},#{?@last_window_name,#{@last_window_name},}}" "display-message -d 800 \" [Window] → #{window_name}\"; set -g @last_window_name \"#{window_name}\""'


# ============================================================================
# FINANCE/DEV SPECIFIC ENHANCEMENTS
# ============================================================================

# Quick session switcher for finance workflow
bind F choose-tree -s -f '#{?session_attached,,#{session_name}}' 'switch-client -t %%'

# Toggle between last two windows (great for trading/analysis switching)
bind Tab last-window

# Quick layouts for finance work
bind F1 select-layout main-vertical \; resize-pane -t 1 -x 120
bind F2 select-layout main-horizontal \; resize-pane -t 1 -y 25
bind F3 select-layout tiled

# ============================================================================
# INTEGRATION SETTINGS
# ============================================================================

# Better integration with terminal and WezTerm
set -g focus-events on
set -g set-clipboard on

# Display tmux version and session info on startup  
display-message "tmux #{version} | Session: #{session_name} | Ready for shared workflow!"